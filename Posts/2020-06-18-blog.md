# サイト作った
サイト作りました。  
構成はElm+Bootstrap+GithubPagesで、目的はこういうブログ記事を書くためです。  
そもそもElmを使うのは三回目くらいなのですが、何でも簡単にできるなーという印象になってきました。  
実際、このサイトは結構色々と基本的なことをやってるのでサンプルとして良いんじゃないかと思ってます。  
という訳で資料として記憶の新しい内にまとめておこうと思います。  
ただ、僕はJSに詳しくないし、そもそもフロントエンドはほとんど触ってない状態からElmにだけ入門したという事実は書いておきます。

# そもそもElmって何ですか

## 雑感
```
Elm は JavaScript にコンパイルできる関数型プログラミング言語です
```
と https://guide.elm-lang.jp/ に記載されています。  
僕の印象としては「AltJSではないけれどそういう風にも使うことが出来るよく分からない何か」です。  
AltJSではない、と言い切ったのはAltJSと呼ぶにはJSから離れすぎているからです。    
具体的な差を提示するには知識が欠け過ぎていますが、そもそも過去にはJSへのコンパイルがメインじゃなかったような。  
より詳細な説明は上のリンクを読むことをオススメします。  
雑感としては関数型言語が好きで、フロントエンドをやってみたいけどHTMLやCSS、JSが書きたくない人にとってもオススメな言語です。

## 環境
ところで環境構築って好きな人と嫌いな人がいますよね。  
僕はどちらでもないですけど、環境が壊れてげんなりするのはよくやってきました。  
驚くべきことに、こういうのにありがちな環境が壊れるようなことは一度も無かったんですよね。  
パッケージマネージャは常にまともに機能していましたし、エディタのプラグインもかなり真っ当にサジェストしたりしてました。  
これ、個人的にはかなり驚いた部分で開発がストレスフリーだったなー、と。  
ちなみに僕の環境は

* Windows 10
* elm 1.9.1
* elm-format (そういえばコイツはあんまり動いてたか意識していないがAtomのプラグインが動いていたはずだから多分動いてたんだろう)
* Atom latest
  * elmjutsu
  * language-elm
  * elm-format

という感じです。  
Windowsでも何の問題もなく開発できるのかなり良きですね。  
まぁ、AtomからWSL2のzshとか呼んでたのでこれは時代的な感じもします。

# lmdexpr.com 解説
いよいよ本題です。  
以下は僕のコミットログを眺めつつ、その一つ一つで何をしたかとか書いていく予定です。  
レポジトリは https://github.com/lmdxrp/lmdexpr.com にあるので適宜リンクを貼っていきます。

## [Update 2020-01-30-cats.md](https://github.com/lmdexpr/lmdexpr.com/commit/f3aabd2002bd5422c13478034510ac9502a6d1c6)  
ここまでのコミットは全てサイト作るの面倒だな～という気持ちでMarkdownだけ置いてた感じなので無視して大丈夫です。  
一言付け加えるなら、この段階でもElmのソースはあったと思うのですが、現在は全く残っていません。  
理由としては当初想定していたデザインをコレジャナイ感で投げ捨てたからです。  
悪くはなかったと思うのですが凝り過ぎていたという感じでまず動くものを作っちゃおう、と方向転換しました。

## [とりあえず動く](https://github.com/lmdexpr/lmdexpr.com/commit/1b7e139b21bd6071414186b50b5e3a96af99fd02)  
### 各ファイル概説

* Home.elm
* Page.elm
* elm-package.json

が過去にあったというソースコード達です。  
バージョンが古いこともあって色々と違うので参考にはしないで下さい。  
これの解説は一切しませんし、ここで消えて以降出てくることもありません。
あと、

* .tags1

は未だに何者か分かってないので誰か教えてください。

* Main.elm

がメインのソースコード、というかElmの場合は一つのファイルにじゃんじゃか書いていきます。  
これは確かそうする方が良いんだぜ！って上にもリンクを貼ったガイドに載ってたと思うんですけど、記憶違いだったらごめんなさい。  
自分で読んで確かめてね。  
以下の解説はこれを追ってく形になりますが、その前に周りのファイルについて説明しちゃいましょう。

* elm.json

これがパッケージを管理するJsonファイルです。  
基本的にelmコマンドで勝手に書き換えられるので自分で触る必要はないです。  
このサイトの真似したい時だけコピペしましょう。  

* index.html

これはJSにコンパイルされたElmを呼び出すためのHTMLで[ガイドにも載っているもの](https://guide.elm-lang.jp/interop/)のコピペです。
これも基本的に見る必要はないものですが、Elmではどうしようもないことがあるとたまに触ります。

* optimize.sh

これも[ガイドに載っているもの](https://guide.elm-lang.jp/optimization/asset_size.html)です。  
コンパイル時に
```sh
./optimize.sh src/Main.elm

```
などとして呼び出します。  
詳しくはリンク先をお読み下さい。

### Main.elm 詳説
では、実際にソースを読んでいきます。  
ElmはThe Elm Architectureとよばれるアーキテクチャを採用していて、それに従って記述されます。  
詳しくは https://guide.elm-lang.jp/architecture/ を読めばわかります。  
簡単にはModelでロジックを記述し、動作をupdateで作り、表示をviewで行う、という感じです。  
順にModel→view→updateと眺めていきましょう。

#### Model
今回のサイトはブログがメインなのでコンテンツを格納するためのリストがあります。  
それがcontentsで個数が確定していることと、ランダムアクセスがあることからArrayになっています。  
その中身はBlogContentというオブジェクトになっていて、

* title（タイトル）
* date（作成された日付）
* url（記事があるURL）
* content（記事の中身）

が格納されます。  
またinitを見ると初期状態のmodelを見ることが出来るのですが、最初はcontentの中身がありません。  
これはBlogContentのurlにあるMarkdownをダウンロードして格納するため、それまでは空の状態で管理します。  
そして、どこをロードしているか管理するための変数としてModelにはloadingという変数があります。  
ロードをしないという状態を管理するためにMaybeになっていて、ロード中はどのコンテンツをロードしているかのインデックスを保持します。  
accordionStateに関してはBootstrapで使用されるものになるので一旦は気にせず、次に進みましょう。

#### view
次は一旦updateを飛ばして、ソースコードの最後の方、viewを見ていきます。
ここはかなりBootstrapのライブラリに依存しているので詳しくは https://package.elm-lang.org/packages/rundis/elm-bootstrap/latest/ を見るべきです。  
ここでは本質的な部分だけ紹介します。
[135行目](https://github.com/lmdexpr/lmdexpr.com/commit/1b7e139b21bd6071414186b50b5e3a96af99fd02#diff-de84bd170bc37fbce0a7076c0125dd29R135)を見ると、
ここでmodelのコンテンツを読みだしているのが分かります。  
アコーディオンメニューの中身を設定している部分です。  
viewの面白い所はModelに変更があるとリアクティブにviewの側も反応するところです。  
詳しくはまたupdateにて触れることにします。  
また、[134行目](https://github.com/lmdexpr/lmdexpr.com/commit/1b7e139b21bd6071414186b50b5e3a96af99fd02#diff-de84bd170bc37fbce0a7076c0125dd29R134)を見てください。  
ここで注目するべきは
```elm
onClick <| RequestContent idx content.url
```
です。  
マウスクリックによってRequestContentという何者かが発行されるという風に読みます。  
このRequestContentはMsgという型を持っていてupdateに投げられるメッセージになります。  
そろそろupdateってなんやねん！と気になってきたところでしょうか？

#### update
updateはModelを更新していく方法を記述する部分になります。  
前述のようにModelを更新するとviewに反映されます。  
つまり、プログラマはviewから発行されたメッセージに対してModelをどう変更するか、だけ考えれば良いのです。  
まずどのようなメッセージがあるのかを考えましょう。  
[メッセージ](https://github.com/lmdexpr/lmdexpr.com/commit/1b7e139b21bd6071414186b50b5e3a96af99fd02#diff-de84bd170bc37fbce0a7076c0125dd29R63-R66)
の定義を見てもらうと、三種類のメッセージが発行されうることが分かります。  
そしてupdateはその三種類に対してそれぞれ動作を定義しています。  

##### RequestContent
viewから発行されたRequestContentに対して何をしているかを見ましょう。  
Modelに関してはloadingを設定しています。  
これは今現在において何をロードしているかを表す変数でした。  
ところで実際にロードを行うのはいつなのでしょうか？  
それがupdateの返す値の二つ目、Cmd Msgという型で表される部分です。  
RequestContentを受け取った場合のこれを見るとgetContentを呼び出していて、内部ではHTTPリクエストを投げています。  
更にこの中で[expect](https://github.com/lmdexpr/lmdexpr.com/commit/1b7e139b21bd6071414186b50b5e3a96af99fd02#diff-de84bd170bc37fbce0a7076c0125dd29R87)
を見て見ると、Msgの二つ目Loadedが書かれています。

##### Loaded
HTTPリクエストは非同期に行います。  
よって、完了した場合のレスポンスをどうにか受ける必要があります。  
それもやっぱりMsgとして投げられるのでupdateで受けることになります。  
今回はこのLoadedというMsgを投げることにしました。  
当然ながらHTTPリクエストは失敗する可能性があるのでResult型が採用されています。  
updateではこれをマッチして、成功していれば中身をmodelに格納しています。  
具体的にはloadContentで行っている処理ですが、このパターンマッチングは関数型によく見られる良い機能ですね。  
Haskellに近い文法を採用してはいるものの、Elmの思想は極力簡単であることを目指しているようでHaskellのようなマッチングは出来ません。  
これは良し悪しだと感じていて、Haskellに慣れていると冗長にも見えますが、明確で良いという見方もあります。  
実際、この辺りの処理は簡潔かつリーダビリティに優れるのではないでしょうか？  
尚、このLoadedを受けた段階で次に実行するべきコマンドは無いのでCmd.noneを合わせて返しています。

##### AccordionMsg
最後に残されたAccordionMsgはやはりBootstrapで必要になる部分です。  
これでアコーディオンメニューが開いたり閉じたりする訳ですね。  

#### subscription
長く書いてきましたが、これで最後です。  
一コミット毎にこの文良は大変に見えるかもしれませんが、変更点だけ解説していくので短くなっていく、はず。  
ここまでで残っているコードはsubscriptionの部分です。  
事前に全く話題に出しませんでしたが、これはCmdと併せて副作用を管理する部分です。  
しかし、これもBootstrapのAccordionに関する部分なので気にしなくて大丈夫です。  
今回は使ってませんが、一定時間ごとに処理をするような時に使ったりします。

### 課題
この段階では出来ないことも多くありました。  
例えばAccordionを開くメッセージを発行する部分がテキストにしかかかっていないためにテキストをクリックする必要があったのですが、一方でHTTPリクエストの
発行はアコーディオンメニューのボタン全体でテキストは除外されていました。  
どう動作するか分かりますか？  
[当時のツイート](https://twitter.com/lmdexpr/status/1272743039920820224?ref_src=twsrc%5Etfw)  
こういうことですね。

他にも色々課題がありまして、この後、これを改善していきます。

## [コンテンツのロード方法を変更した](https://github.com/lmdexpr/lmdexpr.com/commit/2f2cdfa3804a3913dacfb2ddd21ec5d80f882dfc)
少しコミットが飛びますが、途中はGithub PagesでHTTPSにするための過程で発生した色々なので割愛。  

### 詳説
このコミットではコミットメッセージ通りにロードの方法を変更しました。  
以前ではクリックで発火していた部分をページにアクセスされた瞬間にロードするようにしました。  
課題として挙げていた部分を解決するためですね。  
最初からこうしなかったのはコンテンツが膨大になった際に重くなることを懸念してですが、現状はそんなに増える予定が無いので最終的にこのような実装にしました。  
実際に[init](https://github.com/lmdexpr/lmdexpr.com/commit/2f2cdfa3804a3913dacfb2ddd21ec5d80f882dfc#diff-de84bd170bc37fbce0a7076c0125dd29R75)
を見ると、いきなりCmdでロードしているのが分かります。  
それに従ってModelも更新されていて、loadedがloadQueueになっています。  
一つを更新するのではなく、一気に更新するのでQueueとして持つように変更しました。  
更にLoadedに対するupdateもQueueから先頭要素を取り出して次のロードを呼び出すようにしています。  
diffを見ても分かるように非常にシンプルになりましたね。

### 課題
これに伴って新たな課題が生まれました。  
TODOとして記載されていますが、ロードされていない記事がそもそもボタンの表示すらされない、ということです。  
中身がないので表示されないのは真っ当にも見えますが、だららっとロードされた順に表示されるのがちょっとキモかったのでTODOとしています。  

## [迷走している感は否めない](https://github.com/lmdexpr/lmdexpr.com/commit/34527ca29dcc150eca5f2ca8e7aafbe4515b588f)

### 詳説
課題の解決としてローディング画面を挟むことにしました。  
viewを切り分けて、loadQueueの中身がある間はviewLoadingを使い、無くなったらviewLoadedを使います。  
viewLoadedが今までのviewになってます。  
更にこのコミットでは同時に少しだけデザインについても考え始めています。  
それがタイトルの「迷走している感」なんですが、色を付けたりしてますね。

### 課題
この段階で機能的にはかなり完成してきています。  
どちらかというとデザインが気になっている段階ですね。  
(多くの人はデザインに気を取られてviewMainが使用されていないことに気付かない)  

## [分からん](https://github.com/lmdexpr/lmdexpr.com/commit/47b650369e72ef2d91431684107a70205780162a)
このタイミングでレスポンシブデザインに対応するため、CSSを導入しています。  
事前に言った通り、ElmファイルはJSにコンパイルされ、index.htmlから呼び出されるので通常通りの適用方法で使えます。  
elm-cssなどを用いてElmだけで完結するのが理想ですが、あまり多くを記述する予定もなかったのでこういう形にしました。  
尚、このコミットはローカルで上手くテスト出来ずに分からないままにpushしたのでこんなコミットメッセージです。

## [分かった](https://github.com/lmdexpr/lmdexpr.com/commit/f608d43c5fe6ce96e0880049ecee572744429923)
パスが通ってないにぇ！  
に気付いて動き始めました。  
ここで残っている問題はアコーディオンメニューのタイトル文字列がはみ出してしまうことでしたが……

## [力こそパワー](https://github.com/lmdexpr/lmdexpr.com/commit/288eacef3aedfa8d69992b74b2d289f2aa0648b9)
タイトルを短くすることで解決しようとしましたがダメでした。

## [add about, contact](https://github.com/lmdexpr/lmdexpr.com/commit/3a44eaa19b91a9f5a535b2416623980b6ecf1a8d)
一先ず課題は置いておいて、デザインも出来たのでaboutやcontactを書きました。

## [はやくねよう](https://github.com/lmdexpr/lmdexpr.com/commit/ce267c5b8630bf9fb6ef4338b573378cb19b57a8)
サイトのタイトル文字にマウスオーバーすると16進数(ASCIIコード)と文字を行き来するようにしました。  
これがやりたくてタイトル文字をASCIIにしてたんですよね。

## [はみ出し回避](https://github.com/lmdexpr/lmdexpr.com/commit/d4df8d330d73a3f7ea8b2208f537dd2d2b2a16e9)
力こそパワーとかで話題に出していたはみ出し問題をようやく解決。  
はみ出したら…表示するやつって標準であるんだすげーってなりました。

## [JSONを導入してコンパイルなしでポスト出来るようにした](https://github.com/lmdexpr/lmdexpr.com/commit/2844fc5465d074bcf78fa9d8373fd14e0d8af51b)
ここで大きな仕様変更があります。  
これまでの仕様だとコンテンツについてをハードコードしているせいで記事をポストするにもElmのコンパイルが必要でした。  
それは面倒ですよね。  
という訳で記事の情報をJSONファイルで切り分けて読みだすようにしました。  
このJSONに関する周りは過去に作った[ClosedCircle](https://github.com/lmdexpr/ClosedCircle)でも使っていたので簡単でしたね。  
JSONの扱いに関しては https://guide.elm-lang.jp/effects/json.html が詳しいので参照ください。  
あと、もう一つ問題としてλという記号がバグることがあって、AtomやらElmをぶっ壊すことがありました。  
これはユニコードを直接書けば良いんですが、Elmは安全のために通常の文字列だとサニタイズされてしまいます。  
よって文字として書いて、文字列に変換するという一手間をやりました。

## 色々
この後三件のコミットで細かい設定（faviconとか）をやりました。  
多少の問題はあったんですが詳しくはコミットを見てください。

## [追記すればするほどデバッグし辛くなっていく](https://github.com/lmdexpr/lmdexpr.com/commit/644b76f047c08103b9a67301ee5b1197692aec9a)
ここで更に使用を追加しました。  
開いている記事に対応してルーティングする機能です。  
メッセージに哀愁が漂ってますが、既にこの時点でローカルデバッグが上手く出来ず、elm reactorと組み合わせていました。  
Elmでルーティングする方法は https://guide.elm-lang.jp/webapps/ が詳しいです。  
が、この段階では上手くいっていません。  
例えばアコーディオンメニューは複数開くことが出来ますが、その場合のURLをどうするか？など問題がありました。

## [たぶんできた](https://github.com/lmdexpr/lmdexpr.com/commit/6a32693a3de61e55de111934021b8a6fd011ca44)
出来てません。  
URLのクエリをパースするのが出来ていないようでした。

## [こうか？](https://github.com/lmdexpr/lmdexpr.com/commit/78b3206c23990eef2933e0f5152b7d50a42f082f)
こうでした。  
上のコミットも含めて解説します。  
当初は/xxxx-xx-xx-xxxのようなURLを想定していましたが、クリックに反応してURLを変更することは出来ても、ここにアクセスされると404になっていました。  
その場所にアプリはないので当然ですね。  
なのでクエリパラメータとして渡す方法を取りました。  
これによって?content=xxxx-xx-xx-xxxという指定でアコーディオンメニューが開いた状態のサイトへアクセスできるようになりました。

# 終わりに
思ったよりも長くなってしまいましたが弊サイトの開発についてまとめてみました。  
いかがでしたか？  
弊サイトがどう作られているのかよく分かりましたね！  
入社して研修が終わった段階なのですが、その合間合間で書いていました。  
仕事でScalaを書いて、終わったらElmを書いて～の日々はそれなりに楽しかったですね。  
今後はしばらく触らないでしょうからポケモンでもやりましょうかね。

